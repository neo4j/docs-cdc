= Example CDC usage in Java

[source, java, role="nocollapse"]
----
import java.io.Closeable;
import java.util.List;
import java.util.Map;
import java.util.concurrent.ScheduledThreadPoolExecutor;
import java.util.concurrent.TimeUnit;
import java.util.concurrent.atomic.AtomicReference;
import org.neo4j.driver.AuthTokens;
import org.neo4j.driver.Driver;
import org.neo4j.driver.GraphDatabase;
import org.neo4j.driver.Query;

public class CDCService implements Closeable {
    private final Driver driver;
    private final ScheduledThreadPoolExecutor scheduler;
    private final AtomicReference<String> cursor = new AtomicReference<>(null);

    private List<Map<String, Object>> selectors = List.of();

    public CDCService(String uri, String user, String password) {
        driver = GraphDatabase.driver(uri, AuthTokens.basic(user, password));
        scheduler = new ScheduledThreadPoolExecutor(1);
    }

    @Override
    public void close() {
        driver.close();
    }

    private void setSelectors(List<Map<String, Object>> selectors) {
        this.selectors = selectors;
    }

    private String currentChangeID() {
        try (var session = driver.session()) {
            return session.executeRead(tx -> {
                var result = tx.run(new Query("CALL cdc.current"));
                return result.single().get("id").asString();
            });
        }
    }

    private String earliestChangeID() {
        try (var session = driver.session()) {
            return session.executeRead(tx -> {
                var result = tx.run(new Query("CALL cdc.earliest"));
                return result.single().get("id").asString();
            });
        }
    }

    private void processChanges() {
        try (var session = driver.session()) {
            session.executeRead(tx -> {
                var result = tx.run(new Query(
                        "CALL cdc.query($from, $selectors)", Map.of("from", cursor.get(), "selectors", selectors)));

                while (result.hasNext()) {
                    var change = result.next();
                    applyChange(change);
                    cursor.set(change.get("id").asString());
                }

                return cursor.get();
            });
        } catch (Exception e) {
            throw new RuntimeException("Error querying/processing changes.", e);
        }
    }

    public void start() {
        cursor.set(currentChangeID());
        scheduler.scheduleWithFixedDelay(this::processChanges, 0, 500, TimeUnit.MILLISECONDS);
        Runtime.getRuntime().addShutdownHook(new Thread(scheduler::shutdownNow));
    }

    private void applyChange(org.neo4j.driver.Record change) {
        var eventType = change.get("event").asMap().get("eventType");
        var operation = change.get("event").asMap().get("operation");
        System.out.printf("Element of type '%s' changed with operation '%s'%n", eventType, operation);
        System.out.println(change);
    }

    public static void main(String... args) {
        try (var cdcService = new CDCService("bolt://localhost:7687", "neo4j", "passw0rd")) {
            List<Map<String, Object>> selectors = List.of(
                    Map.of("select", "n") // Only select nodes
                    );
            cdcService.setSelectors(selectors);
            cdcService.start();

            System.out.println("started querying changes...");

            try {
                cdcService.scheduler.awaitTermination(1, TimeUnit.DAYS);
            } catch (InterruptedException e) {
                throw new RuntimeException(e);
            }

            System.out.println("quitting...");
            System.out.flush();
        }
    }
}
----